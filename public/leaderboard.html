<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sector 317 ‚Äî Leaderboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:#1a1b15;--bg2:#13140f;--surf:#25261f;--surf2:#2e2f27;--bdr:#3a3b33;
      --acc:#c8e03a;--acc2:#9ab02e;--accB:#d4ec46;--accD:rgba(200,224,58,.10);
      --txt:#e2dfd8;--muted:#7a7869;--gold:#f5c842;--silver:#b8bfc7;--bronze:#cd7f32;
      --fd:'Black Ops One',sans-serif;--fc:'Barlow Condensed',sans-serif;--fb:'Barlow',sans-serif;
    }
    html,body{background:var(--bg2);color:var(--txt);font-family:var(--fb);min-height:100vh;}
    body::before{content:'';position:fixed;inset:0;opacity:.03;pointer-events:none;z-index:0;
      background-image:repeating-linear-gradient(0deg,var(--acc) 0,var(--acc) 1px,transparent 1px,transparent 52px),
      repeating-linear-gradient(90deg,var(--acc) 0,var(--acc) 1px,transparent 1px,transparent 52px);}
    .page{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:2rem 1.25rem 4rem;}
    .header{text-align:center;margin-bottom:2rem;}
    .logo{height:68px;width:auto;margin-bottom:.75rem;}
    .header-title{font-family:var(--fd);font-size:clamp(2rem,6vw,3.5rem);color:var(--accB);letter-spacing:.12em;text-transform:uppercase;line-height:1;text-shadow:0 0 40px rgba(200,224,58,.25);}
    .header-sub{font-family:var(--fc);font-size:.9rem;color:var(--muted);letter-spacing:.18em;text-transform:uppercase;margin-top:.4rem;}
    .controls{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem;}
    .refresh-bar{display:flex;align-items:center;gap:.5rem;font-size:.72rem;color:var(--muted);font-family:var(--fc);letter-spacing:.08em;text-transform:uppercase;}
    .refresh-dot{width:7px;height:7px;background:var(--acc2);border-radius:50%;animation:pulse 2s infinite;}
    .refresh-dot.loading{background:var(--muted);animation:none;}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
    .mode-toggle{display:flex;background:var(--surf2);border:1px solid var(--bdr);border-radius:5px;overflow:hidden;}
    .mode-btn{background:none;border:none;padding:.45rem 1.1rem;font-family:var(--fc);font-size:.78rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:all .2s;}
    .mode-btn.active{background:var(--acc);color:var(--bg2);}
    .mode-btn:hover:not(.active){color:var(--accB);}
    .tabs{display:flex;gap:.25rem;border-bottom:2px solid var(--bdr);margin-bottom:1.5rem;flex-wrap:wrap;}
    .tab{background:none;border:none;border-bottom:3px solid transparent;color:var(--muted);padding:.6rem 1.25rem;cursor:pointer;font-family:var(--fc);font-size:.9rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;transition:all .2s;margin-bottom:-2px;}
    .tab:hover{color:var(--txt);}.tab.active{color:var(--accB);border-bottom-color:var(--acc);}
    .board-wrap{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;overflow:hidden;}
    .board-wrap::before{content:'';display:block;height:3px;background:linear-gradient(90deg,transparent,var(--acc2),var(--accB),var(--acc2),transparent);}
    .board-head{background:var(--surf2);padding:.9rem 1.5rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bdr);}
    .board-head-left{display:flex;align-items:center;gap:.75rem;}
    .board-head-title{font-family:var(--fd);font-size:1rem;color:var(--accB);letter-spacing:.1em;text-transform:uppercase;}
    .mode-badge{font-size:.65rem;font-family:var(--fc);font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:.2rem .6rem;border-radius:3px;}
    .badge-avg{background:var(--accD);color:var(--accB);border:1px solid rgba(200,224,58,.25);}
    .badge-cum{background:rgba(90,138,58,.15);color:#74a84a;border:1px solid rgba(90,138,58,.3);}
    .board-count{font-size:.72rem;color:var(--muted);font-family:var(--fc);letter-spacing:.08em;}
    table{width:100%;border-collapse:collapse;}
    thead tr{background:var(--surf2);}
    th{text-align:left;padding:.55rem 1rem;font-size:.63rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);font-family:var(--fc);font-weight:700;border-bottom:1px solid var(--bdr);}
    th.r,td.r{text-align:right;}
    td{padding:.85rem 1rem;border-bottom:1px solid rgba(58,59,51,.6);font-size:.88rem;vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(200,224,58,.03);}
    .rank-cell{font-family:var(--fd);font-size:1.05rem;width:52px;text-align:center;}
    .rank-1{color:var(--gold);}.rank-2{color:var(--silver);}.rank-3{color:var(--bronze);}.rank-n{color:var(--muted);font-size:.9rem;}
    .medal{font-size:1.2rem;}
    .player-name{font-family:var(--fc);font-weight:700;font-size:1rem;letter-spacing:.03em;}
    .player-meta{font-size:.68rem;color:var(--muted);margin-top:.15rem;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
    .time-note{color:var(--acc2);font-family:var(--fc);font-weight:600;}
    .time-best{color:var(--muted);}
    .score-main{font-family:var(--fd);font-size:1.15rem;color:var(--accB);text-align:right;}
    .score-sub{font-size:.68rem;color:var(--muted);text-align:right;margin-top:.1rem;font-family:var(--fc);}
    .state-msg{text-align:center;padding:4rem 2rem;color:var(--muted);font-family:var(--fc);font-size:1rem;letter-spacing:.1em;text-transform:uppercase;}
    .state-msg .icon{font-size:2.5rem;margin-bottom:.75rem;}
    .spinner{width:36px;height:36px;border:3px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 1rem;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .mode-explain{background:var(--surf2);border:1px solid var(--bdr);border-left:3px solid var(--acc2);border-radius:5px;padding:.65rem 1rem;margin-bottom:1.25rem;font-size:.78rem;color:var(--muted);font-family:var(--fc);letter-spacing:.04em;}
    .mode-explain strong{color:var(--accB);}
    .footer{text-align:center;margin-top:3rem;font-size:.72rem;color:var(--muted);font-family:var(--fc);letter-spacing:.1em;text-transform:uppercase;line-height:2;}
    .footer a{color:var(--acc2);text-decoration:none;}.footer a:hover{color:var(--accB);}
    @media(max-width:600px){.col-hide{display:none;}td.col-hide{display:none;}}
  </style>
</head>
<body>
<div class="page">
  <header class="header">
    <img src="/logo.png" class="logo" alt="Sector 317" onerror="this.style.display='none'"/>
    <div class="header-title">Leaderboard</div>
    <div class="header-sub">Top Operatives ‚Äî Ranked by Performance</div>
  </header>
  <div class="controls">
    <div class="mode-toggle">
      <button class="mode-btn active" data-mode="avg" onclick="setMode('avg')">Avg Top 50 Runs</button>
      <button class="mode-btn"        data-mode="cum" onclick="setMode('cum')">Cumulative</button>
    </div>
    <div class="refresh-bar">
      <div class="refresh-dot" id="refreshDot"></div>
      <span id="refreshLabel">Refreshes in 5:00</span>
    </div>
  </div>
  <div class="mode-explain" id="modeExplain">
    <strong>Average Mode:</strong> Each player's average score across their top 50 individual runs. Ties broken by fastest average completion time.
  </div>
  <div class="tabs">
    <button class="tab active" data-period="alltime">All Time</button>
    <button class="tab" data-period="yearly">This Year</button>
    <button class="tab" data-period="monthly">This Month</button>
    <button class="tab" data-period="weekly">This Week</button>
  </div>
  <div class="board-wrap">
    <div class="board-head">
      <div class="board-head-left">
        <span class="board-head-title" id="boardTitle">All-Time Rankings</span>
        <span class="mode-badge badge-avg" id="modeBadge">Avg ¬∑ Top 50</span>
      </div>
      <span class="board-count" id="boardCount"></span>
    </div>
    <div id="boardBody"><div class="state-msg"><div class="spinner"></div>Loading‚Ä¶</div></div>
  </div>
  <footer class="footer">
    <div>Scores auto-update every 5 min ¬∑ Ties broken by fastest avg completion time</div>
    <div><a href="/">Book your session at sector317.com</a></div>
  </footer>
</div>
<script>
const SUPABASE_URL  = 'https://nvidauvtylloquflklsm.supabase.co'
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52aWRhdXZ0eWxsb3F1ZmxrbHNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjE2MzUsImV4cCI6MjA4NzAzNzYzNX0.pbL-ClM5qEh5Ggm25R3C_NhE-BqliD1tFocSPkOYdnY'

let currentPeriod='alltime',currentMode='avg',refreshTimer=null,countdown=300

const VIEW_MAP={
  avg:{
    alltime:{view:'v_leaderboard',rankCol:'rank_all_time'},
    yearly:{view:'v_leaderboard_yearly',rankCol:'rank_yearly'},
    monthly:{view:'v_leaderboard_monthly',rankCol:'rank_monthly'},
    weekly:{view:'v_leaderboard_weekly',rankCol:'rank_weekly'},
  },
  cum:{
    alltime:{view:'v_leaderboard_cumulative',rankCol:'rank_all_time'},
    yearly:{view:'v_leaderboard_yearly_cumulative',rankCol:'rank_yearly'},
    monthly:{view:'v_leaderboard_monthly_cumulative',rankCol:'rank_monthly'},
    weekly:{view:'v_leaderboard_weekly_cumulative',rankCol:'rank_weekly'},
  }
}

const PERIOD_LABELS={alltime:'All-Time Rankings',yearly:'This Year',monthly:'This Month',weekly:'This Week'}

function fmtS(s){if(!s&&s!==0)return null;return`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`}
function rankDisp(r){if(r===1)return'<span class="medal">ü•á</span>';if(r===2)return'<span class="medal">ü•à</span>';if(r===3)return'<span class="medal">ü•â</span>';return`<span class="rank-n">#${r}</span>`}
function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

async function fetchBoard(period,mode){
  const { view } = VIEW_MAP[mode][period]

  if(!SUPABASE_URL || SUPABASE_URL.includes('REPLACE') || !SUPABASE_ANON || SUPABASE_ANON.includes('REPLACE')){
    throw new Error('Credentials not set ‚Äî open leaderboard.html and replace SUPABASE_URL and SUPABASE_ANON with your project values')
  }

  const url = `${SUPABASE_URL}/rest/v1/${view}?select=*&limit=100&order=leaderboard_score.desc`

  const res = await fetch(url, {
    headers: {
      apikey: SUPABASE_ANON,
      Authorization: `Bearer ${SUPABASE_ANON}`,
      Accept: 'application/json'
    }
  })

  // Read body ONCE (prevents double-read / bad json parsing)
  const ct = (res.headers.get('content-type') || '').toLowerCase()
  const raw = await res.text()

  // If not OK, try to surface JSON error from Supabase; otherwise show body preview
  if (!res.ok) {
    if (ct.includes('application/json')) {
      try {
        const err = JSON.parse(raw)
        throw new Error(err.message || err.error_description || `HTTP ${res.status} ${res.statusText}`)
      } catch (_) {
        throw new Error(`HTTP ${res.status} ${res.statusText} (invalid JSON error body)`)
      }
    }
    throw new Error(`HTTP ${res.status} ${res.statusText}. Body: ${raw.slice(0, 200)}`)
  }

  // OK but not JSON => you're getting HTML (rewrite/404), show preview
  if (!ct.includes('application/json')) {
    throw new Error(`Expected JSON but got "${ct || 'unknown'}". Body: ${raw.slice(0, 200)}`)
  }

  // Parse JSON safely
  try {
    return JSON.parse(raw)
  } catch (e) {
    throw new Error(`Could not parse JSON. Body: ${raw.slice(0, 200)}`)
  }
}

function renderBoard(rows,period,mode){
  const { rankCol } = VIEW_MAP[mode][period]
  document.getElementById('boardTitle').textContent = PERIOD_LABELS[period]
  document.getElementById('boardCount').textContent = rows.length ? `${rows.length} operative${rows.length!==1?'s':''}` : ''

  const badge = document.getElementById('modeBadge')
  if(mode==='avg'){badge.textContent='Avg ¬∑ Top 50 Runs';badge.className='mode-badge badge-avg'}
  else{badge.textContent='Cumulative';badge.className='mode-badge badge-cum'}

  if(!rows.length){
    document.getElementById('boardBody').innerHTML='<div class="state-msg"><div class="icon">üéØ</div>No scores yet ‚Äî be the first!</div>'
    return
  }

  const html = rows.map(r=>{
    const rank = r[rankCol] ?? '?'
    const rc = rank===1?'rank-1':rank===2?'rank-2':rank===3?'rank-3':'rank-n'
    const avgT = fmtS(r.avg_seconds), bestT = fmtS(r.best_seconds)

    const runsLbl = mode==='avg'
      ? `${r.runs_in_avg ?? '?'} runs averaged`
      : `${r.total_runs ?? r.total_runs_played ?? '?'} total runs`

    const timeNote = avgT
      ? `<span class="time-note">‚è± avg ${avgT}</span>${bestT?`<span class="time-best"> ¬∑ best ${bestT}</span>`:''}`
      : ''

    const scoreVal = Number(r.leaderboard_score ?? 0).toFixed(mode==='avg'?1:0)
    const scoreLbl = mode==='avg' ? 'avg score' : 'total score'
    const bestLbl  = r.best_run!=null ? `best: ${r.best_run}` : ''

    return `<tr>
      <td class="rank-cell ${rc}">${rankDisp(rank)}</td>
      <td>
        <div class="player-name">${esc(r.player_name ?? 'Unknown')}</div>
        <div class="player-meta"><span>${runsLbl}</span>${timeNote}</div>
      </td>
      <td class="col-hide r" style="color:var(--muted);font-family:var(--fc);font-size:.82rem">${bestLbl}</td>
      <td class="r">
        <div class="score-main">${scoreVal}</div>
        <div class="score-sub">${scoreLbl}</div>
      </td>
    </tr>`
  }).join('')

  document.getElementById('boardBody').innerHTML = `<table><thead><tr>
    <th style="text-align:center">Rank</th><th>Operative</th>
    <th class="col-hide r">Best Run</th><th class="r">Score</th>
  </tr></thead><tbody>${html}</tbody></table>`
}

function showLoading(){
  document.getElementById('boardBody').innerHTML='<div class="state-msg"><div class="spinner"></div>Loading‚Ä¶</div>'
  document.getElementById('refreshDot').classList.add('loading')
}
function showError(m){
  document.getElementById('boardBody').innerHTML=`<div class="state-msg"><div class="icon">‚ö†</div>${esc(m)}</div>`
  document.getElementById('refreshDot').classList.remove('loading')
}

async function loadBoard(period,mode,spinner=true){
  currentPeriod=period; currentMode=mode
  if(spinner) showLoading()
  try{
    const rows = await fetchBoard(period,mode)
    renderBoard(rows,period,mode)
    document.getElementById('refreshDot').classList.remove('loading')
  }catch(e){
    showError('Could not load: ' + e.message)
  }
}

function setMode(mode){
  currentMode=mode
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.toggle('active',b.dataset.mode===mode))
  const ex=document.getElementById('modeExplain')
  ex.innerHTML=mode==='avg'
    ?'<strong>Average Mode:</strong> Each player\'s average score across their top 50 individual runs. Ties broken by fastest average completion time.'
    :'<strong>Cumulative Mode:</strong> Total of every run score ever recorded. Average completion time shown as a fun note. Ties broken by fastest average time.'
  loadBoard(currentPeriod,mode); startRefreshCycle()
}

function startRefreshCycle(){
  countdown=300; clearInterval(refreshTimer)
  refreshTimer=setInterval(()=>{
    countdown--
    const m=Math.floor(countdown/60), s=countdown%60
    document.getElementById('refreshLabel').textContent = countdown>0 ? `Refreshes in ${m}:${String(s).padStart(2,'0')}` : 'Refreshing‚Ä¶'
    if(countdown<=0){ loadBoard(currentPeriod,currentMode,false); countdown=300 }
  },1000)
}

document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
  btn.classList.add('active')
  loadBoard(btn.dataset.period,currentMode)
  startRefreshCycle()
}))

loadBoard('alltime','avg')
startRefreshCycle()
</script>
</body>
</html>
